<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aprende Python v1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .code-font { font-family: 'Fira Code', monospace; }
        .editor-container { background-color: #1e1e1e; border-radius: 0.5rem; overflow: hidden; position: relative; }
        textarea#code-editor { width: 100%; height: 200px; background-color: transparent; color: #d4d4d4; border: none; resize: none; padding: 1rem; outline: none; line-height: 1.5; font-size: 0.9rem; padding-left: 3rem; }
        .line-numbers { position: absolute; left: 0; top: 0; bottom: 0; width: 2.5rem; background-color: #252526; color: #858585; text-align: right; padding: 1rem 0.5rem; font-size: 0.9rem; line-height: 1.5; user-select: none; font-family: 'Fira Code', monospace; }
        .console { background-color: #111827; color: #10b981; font-family: 'Fira Code', monospace; padding: 1rem; border-radius: 0.5rem; min-height: 80px; font-size: 0.85rem; white-space: pre-wrap; border: 1px solid #374151; }
        .console.error { color: #ef4444; }
        
        /* Mobile Menu Transitions */
        #sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-closed { transform: translateX(-100%); }
        .sidebar-open { transform: translateX(0); }
        @media (min-width: 768px) { #sidebar { transform: translateX(0) !important; } }
        #mobile-overlay { background-color: rgba(0,0,0,0.5); transition: opacity 0.3s; }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- OVERLAY MÓVIL -->
    <div id="mobile-overlay" class="fixed inset-0 z-20 hidden md:hidden glass"></div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="fixed md:static inset-y-0 left-0 w-64 bg-white border-r border-gray-200 flex flex-col z-30 sidebar-closed md:transform-none shadow-xl md:shadow-none">
        <div class="p-4 border-b border-gray-100 flex items-center justify-between h-16">
            <div class="flex items-center gap-2 font-bold text-xl text-blue-600">
                <i data-lucide="terminal-square"></i>
                <span>PyTutor</span>
            </div>
            <button id="close-sidebar-btn" class="md:hidden text-gray-500 hover:text-red-500"><i data-lucide="x"></i></button>
        </div>
        <nav class="flex-1 overflow-y-auto p-4">
            <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Temario</p>
            <ul id="lesson-list" class="space-y-1"></ul>
        </nav>
        <div class="p-4 text-xs text-gray-400 border-t text-center">v1.0 Learning Py &copy; 2025</div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full relative z-10 bg-gray-50">
        <header class="bg-white px-4 h-16 shadow-sm md:hidden flex justify-between items-center shrink-0 z-20">
            <div class="flex items-center gap-2 overflow-hidden">
                <i data-lucide="book-open" class="w-5 h-5 text-blue-500 shrink-0"></i>
                <h2 id="mobile-title" class="font-bold text-gray-800 truncate">Cargando...</h2>
            </div>
            <button id="open-menu-btn" class="p-2 text-gray-600 hover:bg-gray-100 rounded-md"><i data-lucide="menu"></i></button>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8">
            <div class="max-w-6xl mx-auto flex flex-col lg:flex-row gap-6">
                <!-- Izquierda: Teoría -->
                <section class="lg:w-1/2 flex flex-col gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center gap-2 mb-4">
                            <span id="lesson-badge" class="px-2 py-1 text-xs font-semibold bg-blue-100 text-blue-700 rounded">...</span>
                            <h1 id="lesson-title" class="text-2xl font-bold text-gray-800 hidden md:block">...</h1>
                        </div>
                        <div id="lesson-theory" class="prose prose-slate max-w-none text-gray-600 text-sm leading-relaxed"></div>
                    </div>
                    <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-100 shadow-sm">
                        <h3 class="font-bold text-indigo-900 flex items-center gap-2 mb-2"><i data-lucide="target" class="w-5 h-5"></i> Tu Misión</h3>
                        <p id="lesson-challenge" class="text-indigo-800 text-sm"></p>
                    </div>
                </section>

                <!-- Derecha: Práctica -->
                <section class="lg:w-1/2 flex flex-col gap-4">
                    <div class="flex justify-between items-end px-1">
                        <label class="text-sm font-semibold text-gray-600 flex items-center gap-2"><i data-lucide="code-2" class="w-4 h-4"></i> Editor Python</label>
                        <button id="reset-btn" class="text-xs text-gray-500 hover:text-red-600 font-medium flex items-center gap-1 transition-colors bg-white px-2 py-1 rounded border border-gray-200 shadow-sm">
                            <i data-lucide="rotate-ccw" class="w-3 h-3"></i> Restablecer
                        </button>
                    </div>
                    <div class="editor-container shadow-inner border border-gray-700">
                        <div class="line-numbers" id="line-numbers">1</div>
                        <textarea id="code-editor" class="code-font" spellcheck="false"></textarea>
                    </div>
                    <div class="flex gap-3">
                        <button id="run-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg shadow active:scale-95 transition-all flex items-center justify-center gap-2">
                            <i data-lucide="play" class="w-4 h-4"></i> Ejecutar
                        </button>
                        <button id="next-btn" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow active:scale-95 transition-all flex items-center justify-center gap-2 animate-bounce">
                            Siguiente <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs text-gray-500 mb-1 font-semibold uppercase tracking-wider">
                            <span>Terminal</span> <span id="console-status" class="hidden text-green-600">● Ejecutado</span>
                        </div>
                        <div id="console-output" class="console">Esperando código...</div>
                    </div>
                    <div id="feedback-box" class="hidden p-4 rounded-lg border text-sm font-medium transition-all"></div>
                </section>
            </div>
            <div class="h-10"></div>
        </div>
    </main>

    <script>
        // --- DATOS Y LÓGICA ---
        const lessons = [
            {
                id: 1,
                title: "Variables",
                category: "Básicos",
                theory: `<p class="mb-3">Una variable es una caja con nombre para guardar datos.</p><div class="bg-gray-100 p-2 rounded text-sm border-l-4 border-blue-400 font-mono text-gray-700">vidas = 3</div>`,
                challenge: "Crea una variable llamada <code>edad</code> y asígnale el valor <code>25</code>.",
                initialCode: "# Escribe tu código abajo:\n\n",
                validate: (code, output) => {
                    if (/edad\s*=\s*25/.test(code)) return { s: true, m: "¡Correcto! Variable creada." };
                    if (/edad\s*=/.test(code)) return { s: false, m: "Valor incorrecto. Usa 25." };
                    return { s: false, m: "Escribe: edad = 25" };
                }
            },
            {
                id: 2,
                title: "Strings",
                category: "Básicos",
                theory: `<p class="mb-3">El texto va entre comillas. Puedes sumar (concatenar) textos con <code>+</code>.</p>`,
                challenge: "Crea <code>nombre = \"Ana\"</code> e imprime \"Hola Ana\".",
                initialCode: "nombre = \"\"\n# Imprime el saludo:\n",
                validate: (code, output) => {
                    if (!/nombre\s*=\s*["']Ana["']/.test(code)) return { s: false, m: "Define nombre = \"Ana\"" };
                    if (output.trim() === "Hola Ana") return { s: true, m: "¡Excelente!" };
                    return { s: false, m: "El output debe ser exactamente: Hola Ana" };
                }
            },
            {
                id: 3,
                title: "Decisiones (If)",
                category: "Lógica",
                theory: `<p class="mb-3">Usamos <code>if</code> para condiciones. <strong>La indentación (sangría) es obligatoria</strong>.</p><div class="bg-gray-100 p-2 rounded text-sm border-l-4 border-purple-400 font-mono text-gray-700">if x > 5:<br>&nbsp;&nbsp;print("Si")</div>`,
                challenge: "Si <code>numero</code> es mayor a 10, imprime \"Es mayor\". (numero vale 15).",
                initialCode: "numero = 15\n\n# Escribe tu if aquí:\n",
                validate: (code, output) => {
                    // Validar sintaxis del IF
                    if (!/if\s+[Nn]umero\s*>\s*10\s*:/.test(code)) return { s: false, m: "Sintaxis: if numero > 10:" };
                    
                    // Validar que exista el print con el texto correcto
                    // Regex flexible para: print("Es mayor") o print ( 'Es mayor' )
                    const printRegex = /print\s*\(\s*["']Es mayor["']\s*\)/;
                    if (!printRegex.test(code)) return { s: false, m: "Asegúrate de imprimir \"Es mayor\"" };

                    // Validar la ejecución real
                    if (output.trim() === "Es mayor") return { s: true, m: "¡Correcto! Has usado condicionales." };
                    
                    return { s: false, m: "Algo falló en la salida. Revisa la indentación." };
                }
            }
        ];

        const ui = {
            sidebar: document.getElementById('sidebar'), overlay: document.getElementById('mobile-overlay'),
            openMenuBtn: document.getElementById('open-menu-btn'), closeMenuBtn: document.getElementById('close-sidebar-btn'),
            lessonList: document.getElementById('lesson-list'), desktopTitle: document.getElementById('lesson-title'),
            mobileTitle: document.getElementById('mobile-title'), badge: document.getElementById('lesson-badge'),
            theory: document.getElementById('lesson-theory'), challenge: document.getElementById('lesson-challenge'),
            editor: document.getElementById('code-editor'), lineNumbers: document.getElementById('line-numbers'),
            console: document.getElementById('console-output'), feedback: document.getElementById('feedback-box'),
            consoleStatus: document.getElementById('console-status'), runBtn: document.getElementById('run-btn'),
            nextBtn: document.getElementById('next-btn'), resetBtn: document.getElementById('reset-btn')
        };

        let state = { lessonIndex: 0 };

        function init() {
            renderSidebarList();
            loadLesson(0);
            ui.editor.addEventListener('input', handleEditorInput);
            ui.runBtn.addEventListener('click', executeCode);
            ui.nextBtn.addEventListener('click', () => loadLesson(state.lessonIndex + 1));
            ui.resetBtn.addEventListener('click', resetLesson);
            ui.openMenuBtn.addEventListener('click', openMenu);
            ui.closeMenuBtn.addEventListener('click', closeMenu);
            ui.overlay.addEventListener('click', closeMenu);
            lucide.createIcons();
        }

        function openMenu() { ui.sidebar.classList.remove('sidebar-closed'); ui.sidebar.classList.add('sidebar-open'); ui.overlay.classList.remove('hidden'); }
        function closeMenu() { ui.sidebar.classList.remove('sidebar-open'); ui.sidebar.classList.add('sidebar-closed'); ui.overlay.classList.add('hidden'); }

        function renderSidebarList() {
            ui.lessonList.innerHTML = lessons.map((l, idx) => `
                <li onclick="loadLesson(${idx})" class="p-3 rounded-lg cursor-pointer text-sm font-medium flex items-center justify-between transition-colors ${idx === state.lessonIndex ? 'bg-blue-50 text-blue-700 border border-blue-100' : 'text-gray-600 hover:bg-gray-100'}">
                    <span>${idx + 1}. ${l.title}</span> ${idx < state.lessonIndex ? '<i data-lucide="check" class="w-4 h-4 text-green-500"></i>' : ''}
                </li>`).join('');
            lucide.createIcons();
        }

        function loadLesson(index) {
            if (index >= lessons.length) { alert("¡Curso completado!"); index = 0; }
            state.lessonIndex = index;
            const l = lessons[index];
            closeMenu();
            ui.desktopTitle.textContent = l.title; ui.mobileTitle.textContent = l.title;
            ui.badge.textContent = `Nivel ${index + 1} • ${l.category}`;
            ui.theory.innerHTML = l.theory; ui.challenge.innerHTML = l.challenge;
            ui.editor.value = l.initialCode; handleEditorInput();
            ui.console.textContent = "Esperando código..."; ui.console.classList.remove('error');
            ui.feedback.classList.add('hidden'); ui.nextBtn.classList.add('hidden'); ui.runBtn.classList.remove('hidden');
            renderSidebarList();
        }

        function resetLesson() { loadLesson(state.lessonIndex); }
        function handleEditorInput() { 
            ui.lineNumbers.innerHTML = Array(ui.editor.value.split('\n').length).fill(0).map((_, i) => i + 1).join('<br>'); 
        }

        // --- MOTOR DE PYTHON SIMULADO (CORREGIDO) ---
        function executeCode() {
            const code = ui.editor.value;
            const lines = code.split('\n');
            let output = "";
            let error = null;
            let mockVars = { 'numero': 15, 'Numero': 15 }; // Inicializar ambas variables para prevenir errores de Case

            try {
                lines.forEach((line, index) => {
                    // 1. Detectar indentación (IMPORTANTE: Si tiene espacios al inicio, lo saltamos del flujo principal)
                    // Esto evita que el contenido de un IF se ejecute dos veces
                    if (line.startsWith(' ') || line.startsWith('\t')) {
                        return; 
                    }

                    const l = line.trim();
                    if (!l || l.startsWith('#')) return;

                    // Asignaciones
                    if (l.includes('=') && !l.startsWith('if') && !l.startsWith('print')) {
                        const [key, ...vals] = l.split('=');
                        let val = vals.join('=').trim();
                        if (val.startsWith('"') || val.startsWith("'")) val = val.slice(1, -1);
                        else val = parseFloat(val);
                        mockVars[key.trim()] = val;
                    }

                    // Print (Nivel Superior)
                    if (l.startsWith('print(')) {
                        output += processPrint(l, mockVars) + "\n";
                    }

                    // Lógica Especial del IF (Nivel 3)
                    if (l.startsWith('if') && state.lessonIndex === 2) {
                        // Regex flexible para números mayúscula/minúscula
                        const condition = l.replace('if', '').replace(':', '').trim();
                        
                        // Evaluar condición de forma segura usando las variables mockeadas
                        let conditionMet = false;
                        if (condition.includes('>')) {
                            const [left, right] = condition.split('>').map(x => x.trim());
                            // Buscar valor en mockVars (sea numero o Numero)
                            const leftVal = mockVars[left] !== undefined ? mockVars[left] : parseFloat(left);
                            const rightVal = parseFloat(right);
                            if (leftVal > rightVal) conditionMet = true;
                        }

                        if (conditionMet) {
                            // Buscar print en las siguientes líneas (simulación de bloque)
                            // Buscamos cualquier print("Es mayor") en todo el código
                            // Usamos regex flexible para capturar print ( "Es mayor" ) con espacios
                            if (/print\s*\(\s*["']Es mayor["']\s*\)/.test(code)) {
                                output += "Es mayor\n";
                            }
                        }
                    }
                });

                ui.console.textContent = output || "> Sin salida.";
            } catch (e) {
                error = e.message;
                ui.console.textContent = "Error: " + e.message;
                ui.console.classList.add('error');
            }

            if (!error) {
                const check = lessons[state.lessonIndex].validate(code, output);
                showFeedback(check.s, check.m);
                if (check.s) ui.nextBtn.classList.remove('hidden');
            }
        }

        function processPrint(line, vars) {
            const content = line.slice(line.indexOf('(') + 1, line.lastIndexOf(')'));
            const parts = content.split('+');
            let res = "";
            parts.forEach(p => {
                p = p.trim();
                if (p.startsWith('"') || p.startsWith("'")) res += p.slice(1, -1);
                else if (vars[p] !== undefined) res += vars[p];
                else if (!isNaN(p)) res += p;
                else res += p; // Fallback simple
            });
            return res;
        }

        function showFeedback(success, msg) {
            ui.feedback.classList.remove('hidden', 'bg-green-50', 'text-green-800', 'border-green-200', 'bg-red-50', 'text-red-800', 'border-red-200');
            const color = success ? 'green' : 'red';
            const icon = success ? 'check-circle' : 'x-circle';
            ui.feedback.classList.add(`bg-${color}-50`, `text-${color}-800`, `border-${color}-200`);
            ui.feedback.innerHTML = `<div class="flex items-center gap-2 font-bold"><i data-lucide="${icon}"></i> ${success ? '¡Correcto!' : 'Revisa tu código'}</div><div class="mt-1 ml-6">${msg}</div>`;
            lucide.createIcons();
            if (window.innerWidth < 768) ui.feedback.scrollIntoView({ behavior: "smooth" });
        }

        init();
    </script>
</body>
</html>